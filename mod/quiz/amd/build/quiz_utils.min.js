define("mod_quiz/quiz_utils",["exports","mod_quiz/quiz_toolboxes","core/templates","core/notification","core/str","core/prefetch","mod_quiz/dragdrop/dropzone"],(function(_exports,_quiz_toolboxes,_templates,_notification,_str,_prefetch,_dropzone){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Render the question slot template for each question in the quiz edit view.
   *
   * @module     mod_quiz/quiz_utils
   * @copyright  2024 The Open University.
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.util=_exports.slot=_exports.page=void 0,_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),_prefetch=_interopRequireDefault(_prefetch),_dropzone=_interopRequireDefault(_dropzone),_prefetch.default.prefetchStrings("moodle",["question","page"]),_prefetch.default.prefetchStrings("quiz",["removepagebreak","addpagebreak","questiondependencyremove","questiondependsonprevious","questiondependencyadd","questiondependencyfree"]);const slot={CSS:{SLOT:"slot",QUESTIONTYPEDESCRIPTION:"qtype_description",CANNOT_DEPEND:"question_dependency_cannot_depend"},CONSTANTS:{SLOTIDPREFIX:"slot-",QUESTION:JSON.parse(document.querySelector(".config-toolbox").dataset.lang).question},SELECTORS:{SLOT:"li.slot",INSTANCENAME:".instancename",NUMBER:"span.slotnumber",PAGECONTENT:"div#page-content",PAGEBREAK:"span.page_split_join_wrapper",ICON:".icon",QUESTIONTYPEDESCRIPTION:".qtype_description",SECTIONUL:"ul.section",DEPENDENCY_WRAPPER:".question_dependency_wrapper",DEPENDENCY_LINK:".question_dependency_wrapper .cm-edit-action",DEPENDENCY_ICON:".question_dependency_wrapper .icon"},getSlotFromComponent:function(slotComponent){return slotComponent.closest(this.SELECTORS.SLOT)},getId:function(slot){let id=slot.id.replace(this.CONSTANTS.SLOTIDPREFIX,"");return id=parseInt(id,10),!("number"!=typeof id||!isFinite(id))&&id},getName:function(slot){const instance=slot.querySelector(this.SELECTORS.INSTANCENAME);return instance?instance.firstChild.data:null},getNumber(slot){if(!slot)return!1;let number=slot.querySelector(this.SELECTORS.NUMBER).textContent.replace(this.CONSTANTS.QUESTION,"");return number=parseInt(number,10),!isNaN(number)&&number},setNumber(slot,number){slot.querySelector(this.SELECTORS.NUMBER).innerHTML='<span class="accesshide">'+this.CONSTANTS.QUESTION+"</span> "+number},getSlots(){return document.querySelectorAll(this.SELECTORS.PAGECONTENT+" "+this.SELECTORS.SECTIONUL+" "+this.SELECTORS.SLOT)},getNumberedSlots(){let selector=this.SELECTORS.PAGECONTENT+" "+this.SELECTORS.SECTIONUL;return selector+=" "+this.SELECTORS.SLOT+":not("+this.SELECTORS.QUESTIONTYPEDESCRIPTION+")",document.querySelectorAll(selector)},getPrevious:function(slot){let previousSlot=slot.previousElementSibling;for(;previousSlot;){if(previousSlot.matches(this.SELECTORS.SLOT))return previousSlot;previousSlot=previousSlot.previousElementSibling}return!1},getPreviousNumbered(slot){let previous=slot.previousElementSibling;for(;previous;){if(previous.matches(this.SELECTORS.SLOT+":not("+this.SELECTORS.QUESTIONTYPEDESCRIPTION+")"))return previous;previous=previous.previousElementSibling}let section=slot.closest("li.section").previousElementSibling;for(;section;){const questions=section.querySelectorAll(this.SELECTORS.SLOT+":not("+this.SELECTORS.QUESTIONTYPEDESCRIPTION+")");if(questions.length>0)return questions[questions.length-1];section=section.previousElementSibling}return!1},reorderSlots(){this.getSlots().forEach(((slot,index)=>{if(!page.getPageFromSlot(slot)){const nextPage=slot.nextElementSibling;nextPage&&slot.parentNode.insertBefore(nextPage,slot)}slot.classList.contains(this.CSS.QUESTIONTYPEDESCRIPTION)||(this.setNumber(slot,index+1),slot.dataset.slotorder=index+1,slot.dataset.page=page.getPageFromSlot(slot).id.replace(/^\D+/g,""))}))},updateOneSlotSections(){document.querySelectorAll(".mod-quiz-edit-content ul.slots li.section").forEach((section=>{section.querySelectorAll(this.SELECTORS.SLOT).length>1?section.classList.remove("only-has-one-slot"):section.classList.add("only-has-one-slot")}))},remove:function(slot){const pageElement=page.getPageFromSlot(slot);slot.remove(),page.isEmpty(pageElement)&&page.remove(pageElement,!1)},getPageBreaks(){let selector=this.SELECTORS.PAGECONTENT+" "+this.SELECTORS.SECTIONUL;return selector+=" "+this.SELECTORS.SLOT+this.SELECTORS.PAGEBREAK,document.querySelectorAll(selector)},getPageBreak:function(slot){return slot.querySelector(this.SELECTORS.PAGEBREAK)},addPageBreak(slot){let nodeText=_quiz_toolboxes.config.addpageiconhtml;nodeText=nodeText.replace("%%SLOT%%",this.getNumber(slot));let pageBreak=document.createElement("div");return pageBreak.innerHTML=nodeText,slot.querySelector("div").insertAdjacentElement("afterend",pageBreak),pageBreak},removePageBreak:function(slot){const pageBreak=this.getPageBreak(slot);return!!pageBreak&&(pageBreak.remove(),!0)},reorderPageBreaks:async function(){const slots=this.getSlots();let slotNumber=0;const[stringRemovePageBreak,stringAddPageBreak]=await(0,_str.getStrings)([{key:"removepagebreak",component:"quiz"},{key:"addpagebreak",component:"quiz"}]);slots.forEach(((slot,key)=>{slotNumber++;let pageBreak=this.getPageBreak(slot);const nextItem=slot.nextElementSibling&&slot.nextElementSibling.matches("li.activity")?slot.nextElementSibling:null;if(!nextItem)return;pageBreak||(pageBreak=this.addPageBreak(slot)),pageBreak&&key===slots.length-1&&this.removePageBreak(slot);const pageBreakLink=pageBreak.firstElementChild;let action="",iconName="",stringPagebreak="";page.isPage(nextItem)?(action="removepagebreak",iconName="e/remove_page_break",stringPagebreak=stringRemovePageBreak):(action="addpagebreak",iconName="e/insert_page_break",stringPagebreak=stringAddPageBreak),pageBreakLink.title=stringPagebreak,pageBreakLink.dataset.action=action;const icon=pageBreakLink.querySelector(this.SELECTORS.ICON);icon.title=stringPagebreak,icon.alt=stringPagebreak,icon.src=M.util.image_url(iconName);const params=new URLSearchParams(pageBreakLink.href);params.set("slot",slotNumber+""),pageBreakLink.href&&(pageBreakLink.href="".concat(pageBreakLink.href.split("?")[0],"?").concat(params.toString()))}))},updateAllDependencyIcons:function(){const slots=this.getSlots();let slotNumber=0,previousSlot=null;slots.forEach((slot=>{var _previousSlot;slotNumber++;const dependencyWrapper=slot.querySelector(this.SELECTORS.DEPENDENCY_WRAPPER);1===slotNumber||"0"===(null===(_previousSlot=previousSlot)||void 0===_previousSlot?void 0:_previousSlot.dataset.canfinish)?dependencyWrapper.classList.add(this.CSS.CANNOT_DEPEND):dependencyWrapper.classList.remove(this.CSS.CANNOT_DEPEND),this.updateDependencyIcon(slot,null),previousSlot=slot}))},updateDependencyIcon:async function(slot,requiresPrevious){const link=slot.querySelector(this.SELECTORS.DEPENDENCY_LINK),icon=slot.querySelector(this.SELECTORS.DEPENDENCY_ICON),previousSlot=this.getPrevious(slot),a={thisq:this.getNumber(slot)};if(previousSlot&&(a.previousq=this.getNumber(previousSlot)),null===requiresPrevious&&(requiresPrevious="removedependency"===link.dataset.action),requiresPrevious){const[removeDependencyString,dependPreviousString]=await(0,_str.getStrings)([{key:"questiondependencyremove",component:"quiz",a:a},{key:"questiondependsonprevious",component:"quiz"}]);link.title=removeDependencyString,link.dataset.action="removedependency",_templates.default.renderPix("t/locked","core",dependPreviousString).then((html=>(icon.parentNode.innerHTML=html,!0))).catch(_notification.default.exception)}else{const[addDependencyString,dependFreeString]=await(0,_str.getStrings)([{key:"questiondependencyadd",component:"quiz",a:a},{key:"questiondependencyfree",component:"quiz"}]);link.title=addDependencyString,link.dataset.action="adddependency",_templates.default.renderPix("t/unlocked","core",dependFreeString).then((html=>(icon.parentNode.innerHTML=html,!0))).catch(_notification.default.exception)}}};_exports.slot=slot;const page={CSS:{PAGE:"page"},CONSTANTS:{ACTIONMENUIDPREFIX:"action-menu-",ACTIONMENUBARIDSUFFIX:"-menubar",ACTIONMENUMENUIDSUFFIX:"-menu",PAGEIDPREFIX:"page-",PAGENUMBERPREFIX:(0,_str.getString)("page","moodle")+" "},SELECTORS:{ACTIONMENU:"div.moodle-actionmenu",ACTIONMENUBAR:".menubar",ACTIONMENUMENU:".menu",ADDASECTION:'[data-action="addasection"]',PAGE:"li.page",INSTANCENAME:".instancename",NUMBER:"h4"},getPageFromComponent:function(pageComponent){return pageComponent.closest(this.SELECTORS.PAGE)},getPageFromSlot:function(slot){let previousElement=slot.previousElementSibling;for(;previousElement;){if(previousElement.matches(this.SELECTORS.PAGE))return previousElement;previousElement=previousElement.previousElementSibling}return null},getId:function(page){let id=page.id.replace(this.CONSTANTS.PAGEIDPREFIX,"");return id=parseInt(id,10),!(isNaN(id)||!isFinite(id))&&id},setId:function(page,id){page.id="".concat(this.CONSTANTS.PAGEIDPREFIX).concat(id)},getName:function(page){const instance=page.querySelector(this.SELECTORS.INSTANCENAME);var _instance$firstChild$;return instance&&instance.firstChild?null!==(_instance$firstChild$=instance.firstChild.data)&&void 0!==_instance$firstChild$?_instance$firstChild$:instance.firstChild:null},getNumber:function(page){const numberElement=page.querySelector(this.SELECTORS.NUMBER);if(!numberElement)return!1;let number=numberElement.textContent.replace(this.CONSTANTS.PAGENUMBERPREFIX,"");return number=parseInt(number,10),!(isNaN(number)||!isFinite(number))&&number},setNumber:function(page,number){const numberElement=page.querySelector(this.SELECTORS.NUMBER);numberElement&&(0,_str.getString)("page","moodle").then((string=>{numberElement.textContent=string+" "+number}))},getPages:function(){return[...document.querySelectorAll("".concat(slot.SELECTORS.PAGECONTENT," ").concat(slot.SELECTORS.SECTIONUL," ").concat(this.SELECTORS.PAGE))]},isPage:function(page){return page&&page.classList.contains(this.CSS.PAGE)},add:function(beforeNode){const pageFromSlot=this.getPageFromSlot(beforeNode),pageNumber=this.getNumber(pageFromSlot)+1,pageHtmlWithNumber=_quiz_toolboxes.config.pagehtml.replace(/%%PAGENUMBER%%/g,pageNumber),page=document.createElement("div");page.innerHTML=pageHtmlWithNumber;const pageNode=page.firstElementChild;return beforeNode.insertAdjacentElement("afterend",pageNode),new _dropzone.default({element:pageNode}),void 0!==M.core.actionmenu&&M.core.actionmenu.newDOMNode(pageNode),pageNode},isEmpty:function(page){let activity=page.nextElementSibling;for(;activity&&!activity.matches("li.activity");)activity=activity.nextElementSibling;return!activity||!activity.classList.contains("slot")},remove:function(page,keepPageBreak){let previousSlot=page.previousElementSibling;for(;previousSlot&&!previousSlot.matches(slot.SELECTORS.SLOT);)previousSlot=previousSlot.previousElementSibling;!keepPageBreak&&previousSlot&&slot.removePageBreak(previousSlot),page.remove()},reorderPages:function(){const pages=this.getPages();let currentPageNumber=0;pages.forEach((page=>{if(this.isEmpty(page)){var _page$nextElementSibl,_page$nextElementSibl2,_page$nextElementSibl3;const keepPageBreak=null!==(_page$nextElementSibl=null===(_page$nextElementSibl2=page.nextElementSibling)||void 0===_page$nextElementSibl2||null===(_page$nextElementSibl3=_page$nextElementSibl2.classList)||void 0===_page$nextElementSibl3?void 0:_page$nextElementSibl3.contains("slot"))&&void 0!==_page$nextElementSibl&&_page$nextElementSibl;this.remove(page,keepPageBreak)}else currentPageNumber++,this.setNumber(page,currentPageNumber),this.setId(page,currentPageNumber)})),this.reorderActionMenus()},reorderActionMenus:function(){const actionMenus=this.getActionMenus();actionMenus.forEach(((actionMenu,index)=>{const previousActionMenu=actionMenus[index-1],id=(previousActionMenu?this.getActionMenuId(previousActionMenu):0)+1;this.setActionMenuId(actionMenu,id);actionMenu.querySelector(this.SELECTORS.ACTIONMENUBAR).id="".concat(this.CONSTANTS.ACTIONMENUIDPREFIX).concat(id).concat(this.CONSTANTS.ACTIONMENUBARIDSUFFIX);const menuMenu=actionMenu.querySelector(this.SELECTORS.ACTIONMENUMENU);menuMenu.id="".concat(this.CONSTANTS.ACTIONMENUIDPREFIX).concat(id).concat(this.CONSTANTS.ACTIONMENUMENUIDSUFFIX);const addSectionLink=menuMenu.querySelector(this.SELECTORS.ADDASECTION);addSectionLink.href=addSectionLink.href.replace(/\baddsectionatpage=\d+\b/,"addsectionatpage=".concat(id))}))},getActionMenus:function(){return Array.from(document.querySelectorAll("".concat(slot.SELECTORS.PAGECONTENT," ").concat(slot.SELECTORS.SECTIONUL," ").concat(this.SELECTORS.ACTIONMENU)))},getActionMenuId:function(actionMenu){const id=actionMenu.id.replace(this.CONSTANTS.ACTIONMENUIDPREFIX,""),parsedId=parseInt(id,10);return!(isNaN(parsedId)||!isFinite(parsedId))&&parsedId},setActionMenuId:function(actionMenu,id){actionMenu.id="".concat(this.CONSTANTS.ACTIONMENUIDPREFIX).concat(id)}};_exports.page=page;const util={addSpinner:function(node){const WAITICON_pix="i/loading_small",WAITICON_component="moodle",currentSpinner=node.querySelector(".spinner");if(currentSpinner)return currentSpinner;const spinner=this.createElement("img",{src:M.util.image_url(WAITICON_pix,WAITICON_component),class:"spinner iconsmall d-none"});return node.append(spinner),spinner},createElement:function(tag,attributes){const element=document.createElement(tag);for(let key in attributes)element.setAttribute(key,attributes[key]);return element},getNumber:function(content){return content.replace(/^\D+/g,"")}};_exports.util=util}));

//# sourceMappingURL=quiz_utils.min.js.map